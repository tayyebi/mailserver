# Postfix Integration Documentation

This document explains how Postfix is integrated with the mailserver service, where configurations are located, and how they are managed dynamically.

## Overview

Postfix is integrated into the mailserver as one of several services managed by **supervisord**. The entire mail system runs in a single Docker container with the following components:

- **Rust Admin Dashboard** - Manages configurations and generates Postfix config files
- **Postfix** - SMTP server for sending/receiving emails
- **Dovecot** - IMAP/POP3 server for mailbox access
- **OpenDKIM** - DKIM signing for outbound mail
- **Content Filter** - Custom Rust-based filter for tracking pixels and footer injection

## Service Management

### Supervisord Configuration

Postfix runs under supervisord, which is configured in `/etc/supervisord.conf`:

```ini
[program:postfix]
command=/usr/sbin/postfix start-fg
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
```

This ensures Postfix starts automatically and restarts if it crashes.

### Container Startup Flow

1. **Entrypoint script** (`/entrypoint.sh`) runs first:
   - Creates data directories (`/data/ssl`, `/data/dkim`, `/data/mail`, `/data/db`)
   - Ensures system users exist (`vmail`, `opendkim`)
   - Generates self-signed TLS certificate if not present
   - Runs `mailserver seed` to initialize database with default admin user
   - Runs `mailserver genconfig` to generate all mail service configurations
   - Starts supervisord, which launches all services including Postfix

2. **Supervisord** launches all services:
   - `mailserver serve` - Admin dashboard
   - `postfix start-fg` - Postfix SMTP server
   - `dovecot -F` - Dovecot IMAP/POP3 server
   - `opendkim -f` - OpenDKIM signer

## Postfix Configuration

### Configuration File Locations

All Postfix configuration files are generated dynamically by the Rust admin application:

| File | Location | Purpose |
|------|----------|---------|
| `main.cf` | `/etc/postfix/main.cf` | Main Postfix configuration |
| `master.cf` | `/etc/postfix/master.cf` | Service definitions and port configurations |
| `virtual_domains` | `/etc/postfix/virtual_domains` | List of domains handled by the server |
| `vmailbox` | `/etc/postfix/vmailbox` | Virtual mailbox mappings (user@domain â†’ maildir path) |
| `virtual_aliases` | `/etc/postfix/virtual_aliases` | Email alias/forwarding rules |
| `sender_login_maps` | `/etc/postfix/sender_login_maps` | Sender authentication mappings |

### Configuration Generation

The configuration files are generated by the Rust admin application in `src/config.rs`. This happens in two scenarios:

1. **At container startup** - `mailserver genconfig` command (called by `entrypoint.sh`)
2. **After admin changes** - When domains, accounts, or aliases are added/modified via the dashboard

#### Generation Process

The `generate_all_configs()` function in `src/config.rs` performs the following:

```rust
pub fn generate_all_configs(db: &Database, hostname: &str) {
    generate_postfix_main_cf(hostname);
    generate_postfix_master_cf();
    generate_virtual_domains(db);
    generate_virtual_mailboxes(db);
    generate_virtual_aliases(db);
    generate_sender_login_maps(db);
    generate_dovecot_conf(hostname);
    generate_dovecot_passwd(db);
    generate_opendkim_conf();
    generate_opendkim_tables(db);
    postmap_files();
    reload_services();
}
```

### Key Configuration Features

#### main.cf Configuration

Generated by `generate_postfix_main_cf()`, includes:

- **Hostname and domain settings** from `HOSTNAME` environment variable
- **Virtual mailbox delivery** via Dovecot LMTP on port 24
- **SASL authentication** via Dovecot on port 12345
- **TLS certificates** from `/data/ssl/cert.pem` and `/data/ssl/key.pem`
- **DKIM signing** via OpenDKIM milter on port 8891
- **Content filter** named `pixelfilter` for tracking and footer injection
- **Sender login maps** to control which accounts can send as which aliases

#### master.cf Configuration

Generated by `generate_postfix_master_cf()`, defines:

- **Port 25 (smtp)** - Standard SMTP for incoming mail
- **Port 587 (submission)** - Authenticated SMTP submission with TLS encryption
- **Port 465 (smtps)** - SMTP over TLS wrapper mode
- **Port 10025** - Internal reinjection port for content filter (no checks)
- **pixelfilter** - Pipe transport to `/usr/local/bin/mailserver filter` command

#### Virtual Domain, Mailbox, and Alias Files

These files are generated from the SQLite database:

- `virtual_domains` - Lists all active domains from the `domains` table
- `vmailbox` - Maps email addresses to maildir paths for all active accounts
- `virtual_aliases` - Maps alias addresses to destination addresses

After generation, `postmap` is run on each file to create the `.db` hash files that Postfix uses.

#### Sender Login Maps

Generated by `generate_sender_login_maps()`, this file controls which authenticated users can send mail as which addresses:

- Each account can send as their own email address
- Each account can send as any alias on the same domain
- Prevents unauthorized users from spoofing sender addresses

## Content Filter Integration

### How It Works

Postfix is configured to pipe all emails through a custom content filter:

1. **Incoming mail arrives** at Postfix
2. **Postfix pipes the email** to `/usr/local/bin/mailserver filter` (defined in master.cf)
3. **The filter**:
   - Reads the email from stdin
   - Looks up tracking and footer settings from the database
   - Injects tracking pixel if enabled for the recipient alias
   - Adds HTML footer if configured for the domain
   - Converts to plaintext footer if email is plain text
4. **Filter reinjects** the modified email to Postfix on port 10025
5. **Postfix delivers** to Dovecot via LMTP

### Content Filter Configuration

In `main.cf`:
```
content_filter = pixelfilter:dummy
```

In `master.cf`:
```
pixelfilter unix -      n       n       -       10      pipe
  flags=Rq user=nobody argv=/usr/local/bin/mailserver filter -f ${sender} -- ${recipient}

127.0.0.1:10025 inet n  -       n       -       -       smtpd
  -o content_filter=
  -o receive_override_options=no_unknown_recipient_checks,no_header_body_checks
  -o smtpd_recipient_restrictions=permit_mynetworks,reject
```

The port 10025 has `content_filter=` (empty) to prevent loops.

## Dynamic Configuration Management

### How Configuration Updates Work

When an admin makes changes via the dashboard:

1. **Database is updated** with the new information
2. **Config files are regenerated** by calling `config::generate_all_configs()`
3. **Postmap is run** on virtual maps to create hash databases
4. **Services are reloaded**:
   - `postfix reload` - Reloads Postfix configuration
   - `dovecot reload` - Reloads Dovecot configuration
   - `kill -USR1 <opendkim_pid>` - Signals OpenDKIM to reload

This happens automatically when:
- Adding/editing/deleting domains
- Adding/editing/deleting accounts
- Adding/editing/deleting aliases
- Generating DKIM keys

### Code Location

All configuration generation logic is in `src/config.rs`, with functions:

- `generate_postfix_main_cf()` - Main Postfix config
- `generate_postfix_master_cf()` - Service definitions
- `generate_virtual_domains()` - Domain list
- `generate_virtual_mailboxes()` - Mailbox mappings
- `generate_virtual_aliases()` - Alias mappings
- `generate_sender_login_maps()` - Sender authentication
- `postmap_files()` - Convert text files to hash databases
- `reload_services()` - Reload all mail services

## Integration with Other Services

### Dovecot Integration

Postfix delivers mail to Dovecot via LMTP:

- **main.cf**: `virtual_transport = lmtp:inet:localhost:24`
- Dovecot listens on port 24 for LMTP connections
- Postfix uses SASL authentication via Dovecot (port 12345)

### OpenDKIM Integration

Postfix uses OpenDKIM as a milter for DKIM signing:

- **main.cf**: `smtpd_milters = inet:localhost:8891`
- OpenDKIM listens on port 8891
- All outbound authenticated mail gets DKIM signed
- DKIM keys are stored in `/data/dkim/` and managed via the admin dashboard

### Admin Dashboard Integration

The admin dashboard (`mailserver serve`) generates all Postfix configs:

- Reads domain, account, and alias data from SQLite database
- Generates Postfix configuration files based on database state
- Automatically reloads Postfix after configuration changes
- Provides DNS record information for proper mail server setup

## Data Persistence

All Postfix-related persistent data is stored in Docker volume `/data`:

- `/data/ssl/cert.pem` and `/data/ssl/key.pem` - TLS certificates
- `/data/mail/` - Maildir mailboxes (organized by domain/username)
- `/data/db/mailserver.sqlite` - SQLite database with all configuration
- `/data/dkim/*.private` - DKIM private keys

The Postfix configuration files in `/etc/postfix/` are NOT persisted because they are dynamically regenerated from the database on every container start.

## Environment Variables

Key environment variables that affect Postfix integration:

| Variable | Default | Description |
|----------|---------|-------------|
| `HOSTNAME` | `localhost` | Mail server hostname, used in main.cf |
| `DB_PATH` | `/data/db/mailserver.sqlite` | SQLite database path |
| `ADMIN_PORT` | `8080` | Admin dashboard port |
| `PIXEL_BASE_URL` | `http://localhost/pixel?id=` | Base URL for tracking pixels |

These are typically set in `.env` file for Docker Compose or passed as `-e` flags to `docker run`.

## Troubleshooting

### Check Postfix Status

```bash
docker exec mailserver postfix status
```

### View Postfix Logs

```bash
docker logs mailserver | grep postfix
```

### View Current Configuration

```bash
docker exec mailserver postconf -n
```

### Manually Reload Postfix

```bash
docker exec mailserver postfix reload
```

### View Generated Config Files

```bash
docker exec mailserver cat /etc/postfix/main.cf
docker exec mailserver cat /etc/postfix/master.cf
docker exec mailserver postmap -q example.com /etc/postfix/virtual_domains
```

### Regenerate All Configurations

```bash
docker exec mailserver /usr/local/bin/mailserver genconfig
```

## Summary

Postfix integration in this mailserver is achieved through:

1. **Supervisord** manages Postfix as a service alongside other components
2. **Dynamic configuration generation** from SQLite database via Rust application
3. **Content filter integration** for tracking and footer injection
4. **Tight integration** with Dovecot (LMTP, SASL) and OpenDKIM (milter)
5. **Automatic reload** when configuration changes are made via admin dashboard

All configuration is managed through the admin dashboard, making it easy to add domains, accounts, and aliases without manually editing Postfix configuration files.
