@startuml
autonumber
skinparam participantPadding 20
skinparam boxPadding 10
skinparam monochrome false
skinparam shadowing false
skinparam defaultFontName Helvetica
skinparam sequenceMessageAlign center

actor "User (MUA)" as User
box "Mail Server Host (Debian/Ubuntu)" #F0F8FF
    participant "Postfix\n(postfix.service)" as PostfixSubmission
    note over PostfixSubmission
        Config: /etc/postfix/master.cf
        Config: /etc/postfix/main.cf
        Logs: journalctl -u postfix
    end note

    participant "Dovecot\n(dovecot.service)" as Dovecot
    
    participant "OpenDKIM\n(opendkim.service)" as OpenDKIM
    note right of OpenDKIM
        Keys: /etc/opendkim/keys/
    end note

    participant "Postfix\n(Queue/Cleanup)" as PostfixQueue
    
    participant "Content Filter\n(pixel-content-filter.sh)" as ContentFilter
    note right of ContentFilter
        Path: /usr/local/bin/pixel-content-filter.sh
        Called by: pipe transport in master.cf
    end note

    participant "Pixel Milter\n(pixelmilter.service)" as PixelMilter
    note right of PixelMilter
        Service: /etc/systemd/system/pixelmilter.service
        Binary: /opt/pixel-tracking/pixelmilter
        Data Dir: /var/lib/pixel-tracking/
        Logs: journalctl -u pixelmilter
    end note

    participant "Postfix Reinject\n(Binary)" as Reinject
    note right of Reinject
        Path: /usr/local/bin/postfix-reinject
    end note

    participant "Postfix\n(smtpd:10025)" as PostfixReinjectListener
    
    participant "Pixel Server\n(pixelserver.service)" as PixelServer
    note right of PixelServer
        Service: /etc/systemd/system/pixelserver.service
        Binary: /opt/pixel-tracking/pixelserver
        Data Dir: /var/lib/pixel-tracking/
        Logs: journalctl -u pixelserver
    end note

    database "Shared Data\n(JSON/Logs)" as DB
    note right of DB
        Path: /var/lib/pixel-tracking/
        Shared by: pixelmilter & pixelserver
    end note
end box
participant "Recipient MTA" as Internet
actor "Recipient" as Recipient

== Submission ==
User -> PostfixSubmission: SMTP (Port 587)\nEHLO, AUTH, MAIL, RCPT, DATA
activate PostfixSubmission

PostfixSubmission -> Dovecot: SASL Authentication
activate Dovecot
Dovecot --> PostfixSubmission: OK
deactivate Dovecot

PostfixSubmission -> OpenDKIM: Milter Protocol (Port 8891)
activate OpenDKIM
OpenDKIM --> PostfixSubmission: Signed Headers (DKIM-Signature)
deactivate OpenDKIM

PostfixSubmission -> PostfixQueue: Enqueue Message
deactivate PostfixSubmission

== Content Filtering (Pixel Injection) ==
note right of PostfixQueue
  Triggered by master.cf:
  content_filter=pixelcontentfilter
end note

PostfixQueue -> ContentFilter: Pipe (spawn)\nArgs: --sender X --recipient Y
activate ContentFilter

ContentFilter -> PixelMilter: Pipe (stdin)\nEmail Content
activate PixelMilter
PixelMilter -> PixelMilter: Inject Tracking Pixel\n(<img> tag)
PixelMilter -> DB: Write Metadata\n(MessageID, Sender, Recipient)
PixelMilter --> ContentFilter: Modified Email (stdout)
deactivate PixelMilter

ContentFilter -> Reinject: Pipe (stdin)\nArgs: --sender X --recipient Y
activate Reinject
Reinject -> PostfixReinjectListener: SMTP (127.0.0.1:10025)\nMAIL FROM: X\nRCPT TO: Y\nDATA
activate PostfixReinjectListener
PostfixReinjectListener -> PostfixQueue: Enqueue Message\n(No Content Filter)
deactivate PostfixReinjectListener
Reinject --> ContentFilter: Success
deactivate Reinject

ContentFilter --> PostfixQueue: Exit 0 (Success)
deactivate ContentFilter

== Delivery ==
PostfixQueue -> Internet: SMTP (Port 25)\nDelivery
activate Internet
Internet --> PostfixQueue: 250 OK
deactivate Internet

== Tracking ==
Recipient -> Recipient: Open Email
Recipient -> PixelServer: HTTPS Request\n(GET /pixel?id=...)
activate PixelServer
PixelServer -> DB: Update Metadata\n(Mark as Opened, IP, UA)
PixelServer --> Recipient: 1x1 GIF
deactivate PixelServer

@enduml
