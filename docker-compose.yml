services:

  # One-shot init: creates data dirs, generates self-signed SSL if missing
  init:
    build:
      context: ./init
      dockerfile: Dockerfile
    container_name: mailserver_init
    env_file: .env
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        echo "[init] Creating data directories..."
        mkdir -p /data/ssl /data/logs /data/mail /data/admin /data/bin \
                 /data/mail-config/opendkim/keys /data/mail-config/postfix \
                 /data/mail-config/dovecot /data/opendkim/keys \
                 /data/dovecot /data/pixel /data/nginx-ssl
        touch /data/logs/dovecot.log /data/logs/postfix.log \
              /data/logs/nginx-access.log /data/logs/nginx-error.log
        [ -f /data/dovecot/passwd ] || { touch /data/dovecot/passwd; chmod 644 /data/dovecot/passwd; }
        if [ ! -f /data/ssl/cert.pem ]; then
          echo "[init] Generating self-signed SSL certificate..."
          openssl req -x509 -nodes -newkey rsa:2048 -sha256 \
            -subj "/CN=$${MAIL_HOST:-localhost}" \
            -addext "subjectAltName=DNS:$${MAIL_HOST:-localhost}" \
            -keyout /data/ssl/key.pem -out /data/ssl/cert.pem -days 365 2>/dev/null
          chmod 600 /data/ssl/key.pem; chmod 644 /data/ssl/cert.pem
          echo "[init] ✓ SSL certificate generated"
        fi
        echo "[init] ✓ Ready"
    volumes:
      - ./data:/data
    restart: "no"

  opendkim:
    build:
      context: ./opendkim
      dockerfile: Dockerfile
    container_name: opendkim
    hostname: opendkim.${MAIL_DOMAIN}
    restart: unless-stopped
    env_file: .env
    environment:
      - TZ=${TZ}
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x opendkim > /dev/null"]
      interval: 60s
      timeout: 10s
      retries: 1
    labels:
      com.mailserver.role: "dkim"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    expose:
      - "${OPENDKIM_PORT:-8891}"
    volumes:
      - ./opendkim/opendkim.conf:/etc/opendkim/opendkim.conf:ro
      - ./opendkim/TrustedHosts:/etc/opendkim/TrustedHosts:ro
      - ./opendkim/KeyTable:/etc/opendkim/KeyTable:ro
      - ./opendkim/SigningTable:/etc/opendkim/SigningTable:ro
      - ./data/opendkim/keys:/etc/opendkim/keys
    depends_on:
      init:
        condition: service_completed_successfully
    networks:
      mailnet:
        ipv4_address: ${OPENDKIM_IP}
    entrypoint: ["opendkim", "-f", "-x", "/etc/opendkim/opendkim.conf"]

  dovecot:
    build:
      context: ./dovecot
      dockerfile: Dockerfile
    container_name: dovecot
    hostname: dovecot.${MAIL_DOMAIN}
    restart: unless-stopped
    env_file: .env
    environment:
      - TZ=${TZ}
      - MAIL_HOST=${MAIL_HOST}
      - DOVECOT_IP=${DOVECOT_IP}
    healthcheck:
      test: >-
        SNI=${MAIL_HOST:-localhost};
        (echo -e "a1 CAPABILITY\na2 LOGOUT" |
        openssl s_client -quiet -connect ${DOVECOT_IP}:993 -servername $${SNI} \
          2>/dev/null | grep -q 'CAPABILITY') &&
        (timeout 2 bash -c "echo > /dev/tcp/${DOVECOT_IP}/12345" 2>/dev/null || exit 0)
      interval: 60s
      timeout: 10s
      retries: 1
    labels:
      com.mailserver.role: "imap"
    volumes:
      - ./data/ssl/cert.pem:/etc/ssl/private/cert.pem:ro
      - ./data/ssl/key.pem:/etc/ssl/private/key.pem:ro
      - ./data/logs/dovecot.log:/var/log/mail.log
      - ./data/mail:/mail
      - ./data/dovecot/passwd:/etc/dovecot/passwd:rw
      - ./data/admin:/var/www/html/database:ro
      - ./data/mail-config:/var/mailserver/config:ro
      - ./dovecot/dovecot.conf:/etc/dovecot/dovecot.conf:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    ports:
      - "${IMAP_PORT:-143}:143"
      - "${IMAPS_PORT:-993}:993"
      - "${POP3_PORT:-110}:110"
      - "${POP3S_PORT:-995}:995"
    expose:
      - "${DOVECOT_LMTP_PORT:-24}"
      - "${DOVECOT_AUTH_PORT:-12345}"
    networks:
      mailnet:
        ipv4_address: ${DOVECOT_IP}
    command: ["dovecot", "-F"]
    depends_on:
      init:
        condition: service_completed_successfully

  reinject:
    build:
      context: ./reinject
      dockerfile: Dockerfile
    container_name: mailserver_reinject
    entrypoint: ["/bin/sh", "-c", "cp /usr/local/bin/postfix-reinject /out/ && echo '[reinject] ✓ Binary ready'"]
    volumes:
      - ./data/bin:/out
    depends_on:
      init:
        condition: service_completed_successfully
    restart: "no"

  postfix:
    build:
      context: ./postfix
      dockerfile: Dockerfile
    container_name: postfix
    hostname: postfix.${MAIL_DOMAIN}
    domainname: ${MAIL_DOMAIN}
    restart: unless-stopped
    env_file: .env
    environment:
      - TZ=${TZ}
      - DOVECOT_IP=${DOVECOT_IP}
      - DOVECOT_AUTH_PORT=${DOVECOT_AUTH_PORT:-12345}
      - DOVECOT_LMTP_PORT=${DOVECOT_LMTP_PORT:-24}
      - OPENDKIM_IP=${OPENDKIM_IP}
      - PIXEL_MILTER_IP=${PIXEL_MILTER_IP}
      # Content filter environment variables
      - PIXEL_BASE_URL=${PIXEL_BASE_URL:-https://${MAIL_HOST}:8443/pixel?id=}
      - TRACKING_REQUIRES_OPT_IN=${TRACKING_REQUIRES_OPT_IN:-false}
      - OPT_IN_HEADER=${OPT_IN_HEADER:-X-Track-Open}
      - DISCLOSURE_HEADER=${DISCLOSURE_HEADER:-X-Tracking-Notice}
      - INJECT_DISCLOSURE=${INJECT_DISCLOSURE:-true}
      - DATA_DIR=/data/pixel
      - LOG_LEVEL=${LOG_LEVEL:-warn}
      - FOOTER_HTML_FILE=/opt/pixelmilter/domain-wide-footer.html
    healthcheck:
      test: ["CMD-SHELL", "postfix status | grep -qi running && /usr/local/bin/healthcheck.sh"]
      interval: 60s
      timeout: 10s
      retries: 1
    labels:
      com.mailserver.role: "smtp"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    ports:
      - "${SMTP_PORT:-25}:25"
      - "${SUBMISSION_PORT:-587}:587"
      - "${SMTPS_PORT:-465}:465"
    volumes:
      - ./postfix/entrypoint.sh:/usr/local/bin/entrypoint.sh:ro
      - ./postfix/healthcheck.sh:/usr/local/bin/healthcheck.sh:ro
      - /var/log/mailserver/postfix:/var/log/postfix:rw
      - /var/spool/postfix
      - ./data/ssl/cert.pem:/etc/ssl/certs/postfix.pem:ro
      - ./data/ssl/key.pem:/etc/ssl/private/postfix.key:ro
      - ./data/logs/postfix.log:/var/log/mail.log
      - ./data/admin:/var/www/html/database:ro
      - ./data/mail-config:/var/mailserver/config:ro
      - ./postfix/resolv.conf:/var/spool/postfix/etc/resolv.conf:ro
      - ./postfix/resolv.conf:/etc/resolv.conf:ro
      - ./postfix/main.cf.tmpl:/templates/main.cf.tmpl:ro
      - ./postfix/master.cf.tmpl:/templates/master.cf.tmpl:ro
      - ./postfix/virtual_aliases.tmpl:/templates/virtual_aliases.tmpl:ro
      - ./postfix/virtual_domains.tmpl:/templates/virtual_domains.tmpl:ro
      - ./postfix/vmailbox.tmpl:/templates/vmailbox.tmpl:ro
      - ./postfix/pixel-content-filter.sh.tmpl:/templates/pixel-content-filter.sh.tmpl:ro
      - ./data/bin/postfix-reinject:/usr/local/bin/postfix-reinject:ro
      - ./data/pixel:/data/pixel
      - ./pixelmilter/domain-wide-footer.html:/opt/pixelmilter/domain-wide-footer.html:ro
    depends_on:
      reinject:
        condition: service_completed_successfully
      init:
        condition: service_completed_successfully
      dovecot:
        condition: service_healthy
      opendkim:
        condition: service_started
      pixelmilter:
        condition: service_started
    networks:
      mailnet:
        ipv4_address: ${POSTFIX_IP}
    entrypoint: ["/usr/local/bin/entrypoint.sh"]

  pixelmilter:
    build:
      context: ./pixelmilter
      dockerfile: Dockerfile
    container_name: pixelmilter
    hostname: pixelmilter.${MAIL_DOMAIN}
    restart: unless-stopped
    env_file: .env
    environment:
      - TZ=${TZ}
      - PIXEL_BASE_URL=${PIXEL_BASE_URL:-https://${MAIL_HOST}:${PIXEL_SERVER_HTTPS_PORT:-8443}/pixel?id=}
      - TRACKING_REQUIRES_OPT_IN=${TRACKING_REQUIRES_OPT_IN:-false}
      - OPT_IN_HEADER=${OPT_IN_HEADER:-X-Track-Open}
      - DISCLOSURE_HEADER=${DISCLOSURE_HEADER:-X-Tracking-Notice}
      - INJECT_DISCLOSURE=${INJECT_DISCLOSURE:-true}
      - DATA_DIR=/data/pixel
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PIXEL_MILTER_ADDRESS=${PIXEL_MILTER_ADDRESS:-0.0.0.0:${PIXEL_MILTER_PORT:-8892}}
      - RUST_LOG_STYLE=never
    volumes:
      - ./pixelmilter/pixelmilter-entrypoint.sh:/usr/local/bin/pixelmilter-entrypoint.sh:ro
      - ./pixelmilter/domain-wide-footer.html:/opt/pixelmilter/domain-wide-footer.html:ro
      - ./data/pixel:/data/pixel
    depends_on:
      init:
        condition: service_completed_successfully
    labels:
      com.mailserver.role: "milter"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    expose:
      - "${PIXEL_MILTER_PORT:-8892}"
    networks:
      mailnet:
        ipv4_address: ${PIXEL_MILTER_IP}
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 60s
      timeout: 10s
      retries: 1
    entrypoint: ["/usr/local/bin/pixelmilter-entrypoint.sh"]

  pixelserver:
    build:
      context: ./pixelserver
      dockerfile: Dockerfile
    container_name: pixelserver
    hostname: pixelserver.${MAIL_DOMAIN}
    restart: unless-stopped
    env_file: .env
    environment:
      - TZ=${TZ}
      - DATA_DIR=/data/pixel
      - LOG_PATH=/data/pixel/requests.log
      - PIXEL_TLS_CERT=/etc/ssl/certs/server.pem
      - PIXEL_TLS_KEY=/etc/ssl/private/server.key
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RUST_LOG_STYLE=never
      - REPORTS_BIND_ADDRESS=${REPORTS_BIND_ADDRESS:-0.0.0.0:${PIXEL_SERVER_REPORTS_PORT:-8444}}
    volumes:
      - ./pixelserver/pixelserver-entrypoint.sh:/usr/local/bin/pixelserver-entrypoint.sh:ro
      - ./data/pixel:/data/pixel
      - ./data/ssl/cert.pem:/etc/ssl/certs/server.pem:ro
      - ./data/ssl/key.pem:/etc/ssl/private/server.key:ro
    depends_on:
      init:
        condition: service_completed_successfully
    labels:
      com.mailserver.role: "pixel-server"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    expose:
      - "${PIXEL_SERVER_HTTPS_PORT:-8443}"
      - "${PIXEL_SERVER_REPORTS_PORT:-8444}"
    networks:
      mailnet:
        ipv4_address: ${PIXEL_SERVER_IP}
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 60s
      timeout: 10s
      retries: 1

  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: mailserver_admin
    hostname: admin.${MAIL_DOMAIN}
    restart: unless-stopped
    env_file: .env
    environment:
      - TZ=${TZ}
      - DB_CONNECTION=sqlite
      - APP_NAME=${APP_NAME:-Administration}
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_URL=${APP_URL:-}
      - APP_KEY=${APP_KEY}
      - CACHE_STORE=${CACHE_STORE:-file}
      - QUEUE_CONNECTION=${QUEUE_CONNECTION:-database}
      # Connection info for client setup display
      - MAIL_HOST=${MAIL_HOST}
      - IMAP_PORT=${IMAP_PORT:-143}
      - IMAPS_PORT=${IMAPS_PORT:-993}
      - POP3_PORT=${POP3_PORT:-110}
      - POP3S_PORT=${POP3S_PORT:-995}
      - SMTP_PORT=${SMTP_PORT:-25}
      - SUBMISSION_PORT=${SUBMISSION_PORT:-587}
      - SMTPS_PORT=${SMTPS_PORT:-465}
    volumes:
      - ./admin/docker/entrypoint.sh:/usr/local/bin/entrypoint.sh:ro
      - ./admin/docker/nginx.conf:/etc/nginx/sites-available/default:ro
      - ./admin/docker/supervisord.conf:/etc/supervisor/conf.d/supervisord.conf:ro
      - ./data/admin:/var/www/html/database:rw
      - ./data/mail-config:/var/www/html/storage/app/mail-config:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      init:
        condition: service_completed_successfully
    expose:
      - "${ADMIN_INTERNAL_PORT:-80}"
    networks:
      mailnet:
        ipv4_address: ${ADMIN_IP:-172.18.0.31}
    healthcheck:
      test: ["CMD-SHELL", "test -f /var/www/html/public/index.php || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      com.mailserver.role: "admin"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  nginx-proxy:
    build:
      context: ./nginx-proxy
      dockerfile: Dockerfile
    container_name: nginx_proxy
    hostname: proxy.${MAIL_DOMAIN}
    restart: unless-stopped
    env_file: .env
    entrypoint: ["/entrypoint.sh"]
    volumes:
      - ./nginx-proxy/entrypoint.sh:/entrypoint.sh:ro
      - ./nginx-proxy/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx-proxy/default.conf:/etc/nginx/templates/default.conf.template:ro
      - ./data/nginx-ssl:/etc/nginx/ssl:rw
      - ./data/logs/nginx-access.log:/var/log/nginx/access.log:rw
      - ./data/logs/nginx-error.log:/var/log/nginx/error.log:rw
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    depends_on:
      init:
        condition: service_completed_successfully
      admin:
        condition: service_started
      pixelserver:
        condition: service_started
    networks:
      mailnet:
        ipv4_address: ${PROXY_IP:-172.18.0.40}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      com.mailserver.role: "reverse-proxy"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  mailnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16
          gateway: 172.18.0.1
