version: '3.8'

services:
  mta:
    hostname: mail.gordarg.com
    container_name: mta
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "postfix status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    build:
      context: .
      dockerfile: Dockerfile.mta
    command: []  # Ensure this is empty
    ports:
      - "25:25"    # SMTP
      - "465:465"  # SMTPS (implicit TLS)
      - "587:587"  # Submission (STARTTLS)
    volumes:
      - ./ssl/public.crt:/etc/ssl/certs/public.crt:ro
      - ./ssl/private.key:/etc/ssl/private/private.key:ro
      - ./data/log:/var/log
      - ./data/vmail:/var/vmail
    networks:
      mail_network:
        aliases:
          - mta
          - mail.gordarg.com
          - mail.tyyi.net
          - mail.0pt.ir

  mda:
    hostname: mda
    container_name: mda
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile.mda
    ports:
      - "110:110"  # POP3
      - "143:143"  # IMAP
      - "993:993"  # IMAPS
    volumes:
      - ./data/vmail:/var/vmail
      - ./data/log:/var/log
    depends_on:
      - mta
    networks:
      mail_network:
        aliases:
          - mda

networks:
  mail_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
