version: '3.8'

services:

  opendkim:
    build:
      context: ./opendkim
      dockerfile: Dockerfile
    container_name: opendkim
    hostname: opendkim.${MAIL_DOMAIN}
    restart: unless-stopped
    env_file: .env
    environment:
      - TZ=${TZ}
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x opendkim >/dev/null || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 1
    labels:
      com.mailserver.role: "dkim"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    expose:
      - "8891"        # DKIM milter socket — used internally by Postfix
    volumes:
      - ./opendkim/TrustedHosts:/etc/opendkim/TrustedHosts:ro
      - ./opendkim/KeyTable:/etc/opendkim/KeyTable:ro
      - ./opendkim/SigningTable:/etc/opendkim/SigningTable:ro
      - ./ssl/opendkim/keys:/etc/opendkim/keys:ro
    networks:
      mailnet:
        ipv4_address: ${OPENDKIM_IP}
    entrypoint: ["opendkim", "-f", "-x", "/etc/opendkim/opendkim.conf"]

  dovecot:
    build:
      context: ./dovecot
      dockerfile: Dockerfile
    container_name: dovecot
    hostname: dovecot.${MAIL_DOMAIN}
    restart: unless-stopped
    env_file: .env
    environment:
      - TZ=${TZ}
      - MAIL_HOST=${MAIL_HOST}
      - DOVECOT_IP=${DOVECOT_IP}
    healthcheck:
      test: >-
        SNI=${MAIL_HOST:-localhost};
        echo -e "a1 CAPABILITY\na2 LOGOUT" |
        openssl s_client -quiet -connect ${DOVECOT_IP}:993 -servername $${SNI} \
          2>/dev/null | grep -q 'CAPABILITY'
      interval: 60s
      timeout: 10s
      retries: 1
    labels:
      com.mailserver.role: "imap"
    volumes:
      - ./ssl/mailserver-cert.pem:/etc/ssl/private/cert.pem:ro
      - ./ssl/mailserver-key.pem:/etc/ssl/private/key.pem:ro
      - ./data/mail:/mail
      - ./dovecot/passwd:/etc/dovecot/passwd
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    expose:
      - "24"          # LMTP listener for Postfix delivery (internal only)
      - "12345"       # SASL auth listener for Postfix (internal only)
    networks:
      mailnet:
        ipv4_address: ${DOVECOT_IP}
    command: ["dovecot", "-F"]

  postfix:
    build:
      context: ./postfix
      dockerfile: Dockerfile
    container_name: postfix
    hostname: postfix.${MAIL_DOMAIN}
    domainname: ${MAIL_DOMAIN}
    restart: unless-stopped
    env_file: .env
    environment:
      - TZ=${TZ}
      - DOVECOT_AUTH_HOST=${DOVECOT_IP}
      - DOVECOT_AUTH_PORT=12345
      - DOVECOT_LMTP_HOST=${DOVECOT_IP}
      - DOVECOT_LMTP_PORT=24
    healthcheck:
      test: ["CMD-SHELL", "postfix status | grep -qi running && /usr/local/bin/healthcheck.sh"]
      interval: 60s
      timeout: 10s
      retries: 1
    labels:
      com.mailserver.role: "smtp"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    ports:
      - "25:25"       # SMTP (unencrypted) — used for mail relay between servers
      - "587:587"     # SMTP with STARTTLS — secure submission from clients
      - "465:465"     # SMTP over SSL/TLS — legacy secure SMTP (less common)
      - "143:143"     # IMAP (unencrypted) — used for STARTTLS upgrade
      - "993:993"     # IMAP over SSL/TLS — secure IMAP access
      - "110:110"     # POP3 - POP3 access
      - "995:995"     # POP3 over SSL/TLS — secure POP3 access
    volumes:
      - /var/spool/postfix
      - ./ssl/mailserver-cert.pem:/etc/ssl/certs/postfix.pem:ro
      - ./ssl/mailserver-key.pem:/etc/ssl/private/postfix.key:ro
    depends_on:
      dovecot:
        condition: service_healthy
      opendkim:
        condition: service_started
    networks:
      mailnet:
        ipv4_address: ${POSTFIX_IP}
    entrypoint: ["/usr/local/bin/entrypoint.sh"]

networks:
  mailnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16
          gateway: 172.18.0.1