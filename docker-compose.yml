version: "3.9"

services:
  mail:
    image: your-postfix-image:latest
    container_name: mail
    restart: unless-stopped
    ports:
      - "25:25"
      - "587:587"
    environment:
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_DOMAIN=${MAIL_DOMAIN}
    volumes:
      # Postfix queue and config
      - ./data/spool:/var/spool/postfix
      - ./data/postfix:/etc/postfix
      # TLS certs (read-only)
      - ./data/ssl:/certs:ro
    # Postfix will use Dovecot SASL over TCP
    # main.cf: smtpd_sasl_type = dovecot
    # main.cf: smtpd_sasl_path = inet:dovecot:12345
    depends_on:
      - opendkim
      - dovecot

  opendkim:
    image: your-opendkim-image:latest
    container_name: opendkim
    restart: unless-stopped
    volumes:
      - ./data/opendkim/keys:/keys
      - ./data/opendkim/conf:/etc/opendkim
    ports:
      - "127.0.0.1:8891:8891"  # milter socket exposed to mail only via docker network

  dovecot:
    image: dovecot/dovecot:latest
    container_name: dovecot
    restart: unless-stopped
    ports:
      - "143:143"   # IMAP + STARTTLS
      - "993:993"   # IMAPS
    environment:
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_DOMAIN=${MAIL_DOMAIN}
    volumes:
      # Mailboxes and Dovecot state
      - ./data/mail:/var/mail/vhosts
      - ./data/dovecot:/var/lib/dovecot
      - ./data/dovecot-conf:/etc/dovecot
      # TLS certs (read-only, shared with Postfix)
      - ./data/ssl:/certs:ro

networks:
  mailnet:
    driver: bridge
