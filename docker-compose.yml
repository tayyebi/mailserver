version: '3.8'

services:

  opendkim:
    build:
      context: ./opendkim
      dockerfile: Dockerfile
    container_name: opendkim
    hostname: opendkim.${MAIL_DOMAIN}
    restart: unless-stopped
    networks: [mailnet]
    env_file: .env
    environment:
      - TZ=${TZ}
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x opendkim >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
    labels:
      com.mailserver.role: "dkim"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    expose:
      - "8891"
    volumes:
      - ./data/opendkim/conf:/etc/opendkim
      - ./data/opendkim/keys:/etc/opendkim/keys
      - ./opendkim/scripts:/scripts:ro

  dovecot:
    build:
      context: ./dovecot
      dockerfile: Dockerfile
    container_name: dovecot
    hostname: dovecot.${MAIL_DOMAIN}
    restart: unless-stopped
    networks: [mailnet]
    ports:
      - "143:143"
      - "993:993"
    expose:
      - "24"       # LMTP over TCP
      - "12345"    # Auth over TCP (SASL)
    volumes:
      - ./data/mail:/mail
      - ./data/ssl:/etc/ssl/private:ro
    env_file: .env
    environment:
      - TZ=${TZ}
      - MAIL_HOST=${MAIL_HOST}
    healthcheck:
      test: ["CMD-SHELL", "SNI=${MAIL_HOST:-localhost}; echo -e \"a1 CAPABILITY\\na2 LOGOUT\" | openssl s_client -quiet -connect 127.0.0.1:993 -servername $$SNI 2>/dev/null | grep -q 'CAPABILITY'"]
      interval: 30s
      timeout: 10s
      retries: 5
    labels:
      com.mailserver.role: "imap"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  postfix:
    build:
      context: ./postfix
      dockerfile: Dockerfile
    container_name: postfix
    hostname: postfix.${MAIL_DOMAIN}
    domainname: ${MAIL_DOMAIN}
    restart: unless-stopped
    networks: [mailnet]
    depends_on:
      - opendkim
      - dovecot
    ports:
      - "25:25"
      - "587:587"
    volumes:
      - ./data/spool:/var/spool/postfix
      - ./data/ssl:/etc/ssl/private:ro
    env_file: .env
    environment:
      - TZ=${TZ}
      - DOVECOT_AUTH_HOST=dovecot
      - DOVECOT_AUTH_PORT=12345
      - DOVECOT_LMTP_HOST=dovecot
      - DOVECOT_LMTP_PORT=24
    healthcheck:
      test: ["CMD-SHELL", "postfix status | grep -qi running"]
      interval: 30s
      timeout: 10s
      retries: 5
    labels:
      com.mailserver.role: "smtp"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


networks:
  mailnet:
    driver: bridge