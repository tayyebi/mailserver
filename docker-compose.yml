services:
  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=mailserver
      - POSTGRES_USER=mailserver
      - POSTGRES_PASSWORD=mailserver
    volumes:
      - maildb:/var/lib/postgresql/data
    restart: unless-stopped

  mailserver:
    image: ghcr.io/tayyebi/mailserver:main
    build: .
    env_file: .env
    depends_on:
      - db
    ports:
      - "${SMTP_PORT:-25}:25"
      - "${SUBMISSION_PORT:-587}:587"
      - "${SMTPS_PORT:-465}:465"
      - "${SMTP_ALT_PORT:-2525}:2525"
      - "${IMAP_PORT:-143}:143"
      - "${IMAPS_PORT:-993}:993"
      - "${POP3_PORT:-110}:110"
      - "${POP3S_PORT:-995}:995"
      - "${HTTP_PORT:-8080}:${HTTP_PORT:-8080}"
    volumes:
      - maildata:/data
    environment:
      - HOSTNAME=${HOSTNAME:-mail.example.com}
      - ADMIN_PORT=${HTTP_PORT:-8080}
      - DATABASE_URL=postgres://mailserver:mailserver@db/mailserver
      - PIXEL_BASE_URL=http://${HOSTNAME:-mail.example.com}:${HTTP_PORT:-8080}/pixel?id=
      - SEED_USER=${SEED_USER:-admin}
      - SEED_PASS=${SEED_PASS:-admin}
      - TZ=${TZ:-UTC}
    restart: unless-stopped

volumes:
  maildata:
  maildb:
