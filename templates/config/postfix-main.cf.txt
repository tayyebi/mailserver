# Generated by mailserver on {{ generated_at }}
myhostname = {{ hostname }}
mydomain = {{ mydomain }}
myorigin = $mydomain
mydestination = localhost
inet_interfaces = all
inet_protocols = all

# Disable local alias database (we only use virtual domains)
alias_maps =
alias_database =

# Virtual mailbox delivery via Dovecot LMTP
virtual_transport = lmtp:inet:127.0.0.1:24
virtual_mailbox_domains = lmdb:/etc/postfix/virtual_domains
virtual_mailbox_maps = lmdb:/etc/postfix/vmailbox
virtual_alias_maps = lmdb:/etc/postfix/virtual_aliases

# SASL auth via Dovecot
smtpd_sasl_type = dovecot
smtpd_sasl_path = inet:127.0.0.1:12345
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous

# TLS
smtpd_tls_cert_file = /data/ssl/cert.pem
smtpd_tls_key_file = /data/ssl/key.pem
smtpd_tls_security_level = may
smtpd_tls_auth_only = yes
smtp_tls_security_level = may

# TLS protocol and cipher configuration for broader client compatibility
# Support TLS 1.2+ for embedded clients (ESP8266, ESP32, older devices)
# TLS 1.0 and 1.1 are deprecated and have known vulnerabilities
smtpd_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtp_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1

# Cipher configuration - include ciphers compatible with ESP8266/ESP32
# Focus on AEAD ciphers (GCM mode) for better security
# Includes both ECDHE (forward secrecy) and non-ECDHE ciphers
# Non-ECDHE ciphers are needed for some ESP8266/ESP32 implementations
smtpd_tls_ciphers = medium
smtpd_tls_mandatory_ciphers = medium
tls_medium_cipherlist = ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-GCM-SHA384

# TLS session cache to improve performance and reduce handshake overhead
# Note: These LMDB databases will persist on disk and may grow over time
# in high-traffic environments. Monitor disk usage in production.
smtpd_tls_session_cache_database = lmdb:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = lmdb:${data_directory}/smtp_scache

# Disable SSL compression (CRIME attack mitigation)
tls_ssl_options = NO_COMPRESSION

# Increase TLS handshake timeout for slower embedded clients
smtpd_timeout = 120s
smtpd_tls_handshake_timeout = 60s

# Milters
smtpd_milters = inet:127.0.0.1:8891
non_smtpd_milters = inet:127.0.0.1:8891
milter_default_action = accept

# Sender login maps â€” allow accounts to send as their aliases
smtpd_sender_login_maps = lmdb:/etc/postfix/sender_login_maps
smtpd_sender_restrictions = reject_authenticated_sender_login_mismatch, permit

# Restrictions
smtpd_recipient_restrictions = permit_sasl_authenticated, permit_mynetworks, reject_unauth_destination

# Client restrictions - allow connections while reducing reverse DNS warnings
# Note: Many legitimate clients have incomplete reverse DNS, so we permit by default
# while maintaining other security restrictions (auth, recipient validation)
smtpd_client_restrictions = permit_mynetworks, permit_sasl_authenticated, permit
smtpd_peername_lookup = no
disable_vrfy_command = yes

# Limits
message_size_limit = 31457280
