# Generated by mailserver on {{ generated_at }}
protocols = imap pop3 lmtp
hostname = {{ hostname }}

mail_location = maildir:/data/mail/%d/%n/Maildir

# Allow system users with UID/GID starting from 100 (Alpine Linux system users)
first_valid_uid = 100
first_valid_gid = 100

ssl = yes
ssl_cert = </data/ssl/cert.pem
ssl_key = </data/ssl/key.pem

# TLS configuration for broader client compatibility (ESP8266, ESP32, embedded clients)
# Support TLS 1.2+ for embedded and modern clients (TLS 1.0/1.1 are deprecated)
ssl_min_protocol = TLSv1.2
ssl_prefer_server_ciphers = yes

# Cipher suite configuration - compatible with constrained devices
# Focus on AEAD ciphers (GCM mode) for better security
# Includes both ECDHE (forward secrecy) and non-ECDHE ciphers
# Non-ECDHE ciphers are needed for some ESP8266/ESP32 implementations
ssl_cipher_list = ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-GCM-SHA384:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4

# Use custom Diffie-Hellman parameters for key exchange
ssl_dh = </usr/share/dovecot/dh.pem

passdb {
  driver = passwd-file
  args = /etc/dovecot/passwd
}

userdb {
  driver = static
  args = uid=vmail gid=vmail home=/data/mail/%d/%n
}

auth_username_format = %u

# Log directly to stdout (no syslog needed)
log_path = /dev/stdout
log_prefix = "dovecot: %s: "

# Log authentication failures with client IP for fail2ban monitoring
auth_verbose = yes
auth_verbose_passwords = no
verbose_ssl = no

# Enable SASL authentication mechanisms for compatibility with various clients
# PLAIN and LOGIN are safe here because:
# - Dovecot has ssl=yes (line 11) with TLS 1.2+ enforced
# - Postfix submission port (587) requires encryption (smtpd_tls_security_level=encrypt)
# - Postfix smtps port (465) uses TLS wrapper mode
auth_mechanisms = plain login

service auth {
  inet_listener sasl {
    address = 127.0.0.1
    port = 12345
  }
}

service lmtp {
  inet_listener lmtp {
    address = 127.0.0.1
    port = 24
  }
}

service imap-login {
  inet_listener imap {
    address = 0.0.0.0
    port = 143
  }
  inet_listener imaps {
    address = 0.0.0.0
    port = 993
    ssl = yes
  }
}

service pop3-login {
  inet_listener pop3 {
    address = 0.0.0.0
    port = 110
  }
  inet_listener pop3s {
    address = 0.0.0.0
    port = 995
    ssl = yes
  }
}

namespace inbox {
  inbox = yes

  mailbox Sent {
    auto = subscribe
    special_use = \Sent
  }

  mailbox Drafts {
    auto = subscribe
    special_use = \Drafts
  }

  mailbox Trash {
    auto = subscribe
    special_use = \Trash
  }

  mailbox Junk {
    auto = subscribe
    special_use = \Junk
  }
}
