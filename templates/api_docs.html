{% extends "layout.html" %}
{% block title %}REST &amp; SOAP API{% endblock %}
{% block content %}
<section>
    <hgroup>
        <small>Integration reference</small>
        <h1>REST &amp; SOAP API</h1>
    </hgroup>
    <p>This mailserver exposes HTTP endpoints for programmatic email access. Authenticate with HTTP Basic Auth (admin credentials) or a Bearer token.</p>
</section>

{% if let Some(msg) = flash %}
<output>{{ msg }}</output>
{% endif %}

<section>
    <hgroup>
        <small>Programmatic access</small>
        <h2>Bearer Token</h2>
    </hgroup>
    <p>Generate a long-lived token to authenticate API requests without sending your admin password. Pass it as <code>Authorization: Bearer &lt;token&gt;</code>.</p>
    {% if let Some(token) = api_token %}
    {% if token != "" %}
    <dl>
        <dt>Current token</dt>
        <dd><code style="word-break:break-all">{{ token }}</code></dd>
    </dl>
    {% endif %}
    {% endif %}
    <form method="post" action="/api/token/generate" onsubmit="return confirm('This will replace any existing token. Continue?')">
        <button type="submit">Generate New Token</button>
    </form>
    {% if let Some(token) = api_token %}
    {% if token != "" %}
    <form method="post" action="/api/token/revoke" style="margin-top:0.5rem" onsubmit="return confirm('This will invalidate the current token. Continue?')">
        <button type="submit">Revoke Token</button>
    </form>
    {% endif %}
    {% endif %}
    <details style="margin-top:1rem">
        <summary>Usage example</summary>
        <pre><code>curl -H "Authorization: Bearer &lt;your-token&gt;" \
  https://{{ hostname }}/api/emails?account_id=1</code></pre>
    </details>
</section>

<section>
    <hgroup>
        <small>Email operations</small>
        <h2>Email REST API</h2>
    </hgroup>
    <p>RESTful JSON endpoints for listing, reading, sending, and deleting emails. Authentication: HTTP Basic Auth (admin credentials) or Bearer token.</p>
    <div class="table-wrap">
    <table>
        <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
        <tbody>
            <tr><td><code>GET</code></td><td><code>/api/emails?account_id={id}&amp;folder={folder}&amp;page={page}</code></td><td>List emails in an account's inbox or folder (20 per page)</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/emails/{filename}?account_id={id}&amp;folder={folder}</code></td><td>Read the full content of a single email</td></tr>
            <tr><td><code>POST</code></td><td><code>/api/emails</code></td><td>Send an email from a mail account</td></tr>
            <tr><td><code>DELETE</code></td><td><code>/api/emails/{filename}?account_id={id}&amp;folder={folder}</code></td><td>Permanently delete an email</td></tr>
        </tbody>
    </table>
    </div>
    <dl>
        <dt>Auth</dt><dd>HTTP Basic Auth (admin username / password) or <code>Authorization: Bearer &lt;token&gt;</code></dd>
        <dt>Content-Type</dt><dd><code>application/json</code> (for POST requests)</dd>
        <dt>filename</dt><dd>Base64url-encoded (no padding) email filename as returned by the list endpoint</dd>
        <dt>folder</dt><dd>Maildir subfolder (e.g. <code>.Sent</code>, <code>.Junk</code>). Omit or leave empty for INBOX.</dd>
    </dl>
    <details>
        <summary>Example: list emails</summary>
        <pre><code>GET /api/emails?account_id=1&amp;page=1
Authorization: Bearer &lt;token&gt;</code></pre>
        <pre><code>{
  "account_id": 1,
  "folder": "INBOX",
  "page": 1,
  "total_pages": 3,
  "total_count": 42,
  "emails": [
    {
      "filename": "base64url-encoded-filename",
      "subject": "Hello",
      "from": "sender@example.com",
      "to": "user@{{ hostname }}",
      "date": "Mon, 1 Jan 2024 12:00:00 +0000",
      "is_new": true,
      "is_spam": false
    }
  ]
}</code></pre>
    </details>
    <details>
        <summary>Example: read email</summary>
        <pre><code>GET /api/emails/&lt;filename&gt;?account_id=1
Authorization: Bearer &lt;token&gt;</code></pre>
        <pre><code>{
  "filename": "base64url-encoded-filename",
  "subject": "Hello",
  "from": "sender@example.com",
  "to": "user@{{ hostname }}",
  "date": "Mon, 1 Jan 2024 12:00:00 +0000",
  "body": "Email body text...",
  "is_spam": false
}</code></pre>
    </details>
    <details>
        <summary>Example: send email</summary>
        <pre><code>POST /api/emails
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "account_id": 1,
  "to": "recipient@example.com",
  "subject": "Hello",
  "body": "Hello from REST API",
  "cc": "",
  "bcc": "",
  "reply_to": "",
  "sender_name": "My Mailserver",
  "body_format": "plain"
}</code></pre>
        <pre><code>{"status": "sent"}</code></pre>
    </details>
    <details>
        <summary>Example: delete email</summary>
        <pre><code>DELETE /api/emails/&lt;filename&gt;?account_id=1
Authorization: Bearer &lt;token&gt;</code></pre>
        <pre><code>{"status": "deleted"}</code></pre>
    </details>
</section>

<section>
    <hgroup>
        <small>Email operations (XML/SOAP)</small>
        <h2>SOAP API</h2>
    </hgroup>
    <p>SOAP 1.1 endpoint for listing, reading, sending, and deleting emails. Authentication: HTTP Basic Auth (admin credentials) or Bearer token.</p>
    <div class="table-wrap">
    <table>
        <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
        <tbody>
            <tr><td><code>GET</code></td><td><code>/api/soap</code></td><td>Download the WSDL service description</td></tr>
            <tr><td><code>POST</code></td><td><code>/api/soap</code></td><td>Execute a SOAP operation</td></tr>
        </tbody>
    </table>
    </div>
    <dl>
        <dt>Auth</dt><dd>HTTP Basic Auth (admin username / password) or <code>Authorization: Bearer &lt;token&gt;</code></dd>
        <dt>Content-Type</dt><dd><code>text/xml; charset=utf-8</code></dd>
        <dt>SOAPAction header</dt><dd><code>urn:mailserver#&lt;OperationName&gt;</code> (e.g. <code>urn:mailserver#ListEmails</code>)</dd>
        <dt>Operations</dt><dd><code>ListEmails</code>, <code>GetEmail</code>, <code>SendEmail</code>, <code>DeleteEmail</code></dd>
        <dt>filename</dt><dd>Base64url-encoded (no padding) email filename, same as in the REST API</dd>
    </dl>
    <details>
        <summary>Example: ListEmails</summary>
        <pre><code>POST /api/soap
Authorization: Bearer &lt;token&gt;
Content-Type: text/xml; charset=utf-8
SOAPAction: "urn:mailserver#ListEmails"

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;soap:Body&gt;
    &lt;ListEmails xmlns="urn:mailserver"&gt;
      &lt;accountId&gt;1&lt;/accountId&gt;
      &lt;folder&gt;&lt;/folder&gt;
      &lt;page&gt;1&lt;/page&gt;
    &lt;/ListEmails&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</code></pre>
        <pre><code>&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:tns="urn:mailserver"&gt;
  &lt;soap:Body&gt;
    &lt;tns:ListEmailsResponse&gt;
      &lt;accountId&gt;1&lt;/accountId&gt;
      &lt;folder&gt;INBOX&lt;/folder&gt;
      &lt;page&gt;1&lt;/page&gt;
      &lt;totalPages&gt;3&lt;/totalPages&gt;
      &lt;totalCount&gt;42&lt;/totalCount&gt;
      &lt;emails&gt;
        &lt;email&gt;
          &lt;filename&gt;base64url-encoded-filename&lt;/filename&gt;
          &lt;subject&gt;Hello&lt;/subject&gt;
          &lt;from&gt;sender@example.com&lt;/from&gt;
          &lt;to&gt;user@{{ hostname }}&lt;/to&gt;
          &lt;date&gt;Mon, 1 Jan 2024 12:00:00 +0000&lt;/date&gt;
          &lt;isNew&gt;true&lt;/isNew&gt;
          &lt;isSpam&gt;false&lt;/isSpam&gt;
        &lt;/email&gt;
      &lt;/emails&gt;
    &lt;/tns:ListEmailsResponse&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</code></pre>
    </details>
    <details>
        <summary>Example: GetEmail</summary>
        <pre><code>POST /api/soap
Authorization: Bearer &lt;token&gt;
Content-Type: text/xml; charset=utf-8
SOAPAction: "urn:mailserver#GetEmail"

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;soap:Body&gt;
    &lt;GetEmail xmlns="urn:mailserver"&gt;
      &lt;accountId&gt;1&lt;/accountId&gt;
      &lt;filename&gt;base64url-encoded-filename&lt;/filename&gt;
    &lt;/GetEmail&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</code></pre>
    </details>
    <details>
        <summary>Example: SendEmail</summary>
        <pre><code>POST /api/soap
Authorization: Bearer &lt;token&gt;
Content-Type: text/xml; charset=utf-8
SOAPAction: "urn:mailserver#SendEmail"

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;soap:Body&gt;
    &lt;SendEmail xmlns="urn:mailserver"&gt;
      &lt;accountId&gt;1&lt;/accountId&gt;
      &lt;to&gt;recipient@example.com&lt;/to&gt;
      &lt;subject&gt;Hello&lt;/subject&gt;
      &lt;body&gt;Hello from SOAP API&lt;/body&gt;
      &lt;senderName&gt;My Mailserver&lt;/senderName&gt;
      &lt;bodyFormat&gt;plain&lt;/bodyFormat&gt;
    &lt;/SendEmail&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</code></pre>
        <pre><code>&lt;tns:SendEmailResponse&gt;&lt;status&gt;sent&lt;/status&gt;&lt;/tns:SendEmailResponse&gt;</code></pre>
    </details>
    <details>
        <summary>Example: DeleteEmail</summary>
        <pre><code>POST /api/soap
Authorization: Bearer &lt;token&gt;
Content-Type: text/xml; charset=utf-8
SOAPAction: "urn:mailserver#DeleteEmail"

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;soap:Body&gt;
    &lt;DeleteEmail xmlns="urn:mailserver"&gt;
      &lt;accountId&gt;1&lt;/accountId&gt;
      &lt;filename&gt;base64url-encoded-filename&lt;/filename&gt;
    &lt;/DeleteEmail&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</code></pre>
        <pre><code>&lt;tns:DeleteEmailResponse&gt;&lt;status&gt;deleted&lt;/status&gt;&lt;/tns:DeleteEmailResponse&gt;</code></pre>
    </details>
</section>
{% endblock %}

