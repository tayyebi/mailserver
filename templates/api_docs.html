{% extends "layout.html" %}
{% block title %}REST API{% endblock %}
{% block content %}
<section>
    <hgroup>
        <small>Integration reference</small>
        <h1>REST API</h1>
    </hgroup>
    <p>This mailserver exposes HTTP endpoints for programmatic email access. Authenticate with HTTP Basic Auth (admin credentials) or a Bearer token.</p>
</section>

{% if let Some(msg) = flash %}
<output>{{ msg }}</output>
{% endif %}

<section>
    <hgroup>
        <small>Programmatic access</small>
        <h2>Bearer Token</h2>
    </hgroup>
    <p>Generate a long-lived token to authenticate API requests without sending your admin password. Pass it as <code>Authorization: Bearer &lt;token&gt;</code>.</p>
    {% if let Some(token) = api_token %}
    {% if token != "" %}
    <dl>
        <dt>Current token</dt>
        <dd><code style="word-break:break-all">{{ token }}</code></dd>
    </dl>
    {% endif %}
    {% endif %}
    <form method="post" action="/api/token/generate" onsubmit="return confirm('This will replace any existing token. Continue?')">
        <button type="submit">Generate New Token</button>
    </form>
    {% if let Some(token) = api_token %}
    {% if token != "" %}
    <form method="post" action="/api/token/revoke" style="margin-top:0.5rem" onsubmit="return confirm('This will invalidate the current token. Continue?')">
        <button type="submit">Revoke Token</button>
    </form>
    {% endif %}
    {% endif %}
    <details style="margin-top:1rem">
        <summary>Usage example</summary>
        <pre><code>curl -H "Authorization: Bearer &lt;your-token&gt;" \
  https://{{ hostname }}/api/emails?account_id=1</code></pre>
    </details>
</section>

<section>
    <hgroup>
        <small>Email operations</small>
        <h2>Email REST API</h2>
    </hgroup>
    <p>RESTful JSON endpoints for listing, reading, sending, and deleting emails. Authentication: HTTP Basic Auth (admin credentials) or Bearer token.</p>
    <table>
        <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
        <tbody>
            <tr><td><code>GET</code></td><td><code>/api/emails?account_id={id}&amp;folder={folder}&amp;page={page}</code></td><td>List emails in an account's inbox or folder (20 per page)</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/emails/{filename}?account_id={id}&amp;folder={folder}</code></td><td>Read the full content of a single email</td></tr>
            <tr><td><code>POST</code></td><td><code>/api/emails</code></td><td>Send an email from a mail account</td></tr>
            <tr><td><code>DELETE</code></td><td><code>/api/emails/{filename}?account_id={id}&amp;folder={folder}</code></td><td>Permanently delete an email</td></tr>
        </tbody>
    </table>
    <dl>
        <dt>Auth</dt><dd>HTTP Basic Auth (admin username / password) or <code>Authorization: Bearer &lt;token&gt;</code></dd>
        <dt>Content-Type</dt><dd><code>application/json</code> (for POST requests)</dd>
        <dt>filename</dt><dd>Base64url-encoded (no padding) email filename as returned by the list endpoint</dd>
        <dt>folder</dt><dd>Maildir subfolder (e.g. <code>.Sent</code>, <code>.Junk</code>). Omit or leave empty for INBOX.</dd>
    </dl>
    <details>
        <summary>Example: list emails</summary>
        <pre><code>GET /api/emails?account_id=1&amp;page=1
Authorization: Bearer &lt;token&gt;</code></pre>
        <pre><code>{
  "account_id": 1,
  "folder": "INBOX",
  "page": 1,
  "total_pages": 3,
  "total_count": 42,
  "emails": [
    {
      "filename": "base64url-encoded-filename",
      "subject": "Hello",
      "from": "sender@example.com",
      "to": "user@{{ hostname }}",
      "date": "Mon, 1 Jan 2024 12:00:00 +0000",
      "is_new": true,
      "is_spam": false
    }
  ]
}</code></pre>
    </details>
    <details>
        <summary>Example: read email</summary>
        <pre><code>GET /api/emails/&lt;filename&gt;?account_id=1
Authorization: Bearer &lt;token&gt;</code></pre>
        <pre><code>{
  "filename": "base64url-encoded-filename",
  "subject": "Hello",
  "from": "sender@example.com",
  "to": "user@{{ hostname }}",
  "date": "Mon, 1 Jan 2024 12:00:00 +0000",
  "body": "Email body text...",
  "is_spam": false
}</code></pre>
    </details>
    <details>
        <summary>Example: send email</summary>
        <pre><code>POST /api/emails
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "account_id": 1,
  "to": "recipient@example.com",
  "subject": "Hello",
  "body": "Hello from REST API",
  "cc": "",
  "bcc": "",
  "reply_to": "",
  "sender_name": "My Mailserver",
  "body_format": "plain"
}</code></pre>
        <pre><code>{"status": "sent"}</code></pre>
    </details>
    <details>
        <summary>Example: delete email</summary>
        <pre><code>DELETE /api/emails/&lt;filename&gt;?account_id=1
Authorization: Bearer &lt;token&gt;</code></pre>
        <pre><code>{"status": "deleted"}</code></pre>
    </details>
</section>
{% endblock %}

