{% extends "layout.html" %}
{% block title %}DNS Records{% endblock %}
{% block content %}
<section>
    <hgroup>
        <small>DNS runbook</small>
        <h1>{{ domain_name }}</h1>
    </hgroup>
    <p>Apply these records to Route 53 (or your DNS provider) to keep the domain aligned.</p>
    <nav>
        <a href="/domains/{{ domain_id }}/check?type=ptr">Check PTR →</a>
        <a href="/domains/{{ domain_id }}/check?type=spf">Check SPF →</a>
    </nav>
    <form method="post" action="/domains/{{ domain_id }}/dkim">
        <button type="submit">Generate DKIM key</button>
    </form>
</section>
<aside>
    <h2>Deployment checklist</h2>
    <ol>
        <li>Update MX and SPF first to establish routing.</li>
        <li>Publish DKIM selector <code>{{ dkim_selector }}</code> and wait for propagation.</li>
        <li>Add DMARC with <code>p=reject</code> to enforce strict policy.</li>
        <li>Verify reverse DNS points back to <code>{{ hostname }}</code>.</li>
        <li>Set up autodiscover records for mail client auto-configuration.</li>
    </ol>
    <small>Catch-all aliases rely on MX reaching this host. Keep DNS fresh.</small>
</aside>
<table>
    <thead><tr><th>Type</th><th>Name</th><th>Value</th><th>Purpose</th></tr></thead>
    <tbody>
        <tr><td>MX</td><td>@</td><td><code>10 {{ hostname }}.</code></td><td>Primary mail exchanger</td></tr>
        <tr><td>TXT</td><td>@</td><td><code>v=spf1 a mx include:{{ hostname }} ~all</code></td><td>Baseline SPF policy</td></tr>
        {% if !dkim_record.is_empty() %}
        <tr><td>TXT</td><td><code>{{ dkim_selector }}._domainkey</code></td><td><code>v=DKIM1; k=rsa; p={{ dkim_record }}</code></td><td>DKIM signing key</td></tr>
        {% endif %}
        {# DMARC record (RFC 7489 §6.3).
           rua: aggregate report URI — receiving MTAs POST daily XML summaries to this
                RFC 5321 mailbox address (local-part@domain, RFC 5321 §4.1.2) via SMTP.
           ruf: failure report URI  — receiving MTAs deliver per-message forensic reports
                in ARF format (RFC 6591 / RFC 5965) to this RFC 5321 mailbox address via SMTP.
           Both fall back to postmaster@<domain> (RFC 5321 §4.5.1) when not configured. #}
        <tr><td>TXT</td><td>_dmarc</td><td><code>v=DMARC1; p=reject; adkim=s; aspf=s; fo=1; rua=mailto:{% if let Some(rua) = dmarc_rua %}{{ rua }}{% else %}postmaster@{{ domain_name }}{% endif %}; ruf=mailto:{% if let Some(ruf) = dmarc_ruf %}{{ ruf }}{% else %}postmaster@{{ domain_name }}{% endif %}</code></td><td>DMARC enforcement</td></tr>
        <tr><td>SRV</td><td>_autodiscover._tcp</td><td><code>0 0 443 {{ hostname }}.</code></td><td>Outlook autodiscover</td></tr>
        <tr><td>CNAME</td><td>autoconfig</td><td><code>{{ hostname }}.</code></td><td>Thunderbird autoconfig</td></tr>
        <tr><td>CNAME</td><td>autodiscover</td><td><code>{{ hostname }}.</code></td><td>Outlook autodiscover</td></tr>
        <tr><td>SRV</td><td>_imaps._tcp</td><td><code>0 1 993 {{ hostname }}.</code></td><td>IMAP service discovery</td></tr>
        <tr><td>SRV</td><td>_submission._tcp</td><td><code>0 1 587 {{ hostname }}.</code></td><td>SMTP submission discovery</td></tr>
        {% if has_bimi %}
        <tr><td>TXT</td><td>default._bimi</td><td><code>v=BIMI1; l={{ bimi_logo_url }}</code></td><td>BIMI brand logo</td></tr>
        {% endif %}
    </tbody>
</table>
<section>
    <hgroup>
        <small>DKIM payload</small>
        <h2>Selector {{ dkim_selector }}</h2>
    </hgroup>
    {% if !dkim_record.is_empty() %}
    <figure>
        <figcaption><small>selector: {{ dkim_selector }}</small></figcaption>
        <pre>v=DKIM1; k=rsa; p={{ dkim_record }}</pre>
    </figure>
    {% else %}
    <p><em>Generate a DKIM key to unlock signing coverage.</em></p>
    {% endif %}
</section>
<section>
    <hgroup>
        <small>DMARC report inbox</small>
        <h2>DMARC</h2>
    </hgroup>
    {% if let Some(inbox) = dmarc_inbox %}
    <p>
        Aggregate reports (rua) are delivered to
        <strong>{{ inbox.account_username.as_deref().unwrap_or("?") }}@{{ inbox.account_domain.as_deref().unwrap_or("?") }}</strong>.
        <a href="/dmarc/{{ inbox.id }}/reports">View reports →</a>
    </p>
    <form method="post" action="/domains/{{ domain_id }}/dmarc/delete" class="form-inline">
        <button type="submit" class="button-danger button-small">Remove DMARC inbox</button>
    </form>
    {% else %}
    <p>No DMARC report inbox configured for this domain.</p>
    {% endif %}
    {% if !domain_accounts.is_empty() %}
    <form method="post" action="/domains/{{ domain_id }}/dmarc">
        <label for="dmarc_account_id">Set DMARC rua inbox account:</label>
        <select name="account_id" id="dmarc_account_id" required>
            <option value="">— Select account —</option>
            {% for a in domain_accounts %}
            <option value="{{ a.id }}"{% if let Some(inbox) = dmarc_inbox %}{% if inbox.account_id == a.id %} selected{% endif %}{% endif %}>{{ a.username }}@{{ a.domain_name.as_deref().unwrap_or("?") }}</option>
            {% endfor %}
        </select>
        <button type="submit">Save</button>
    </form>
    {% else %}
    <p><small>Create an account for this domain first to enable DMARC reporting.</small></p>
    {% endif %}
</section>
<section>
    <hgroup>
        <small>DMARC failure report inbox</small>
        <h2>DMARC ruf</h2>
    </hgroup>
    {% if let Some(inbox) = dmarc_inbox %}
    {% if let Some(ruf_username) = inbox.ruf_account_username.as_deref() %}
    <p>
        Failure reports (ruf) are delivered to
        <strong>{{ ruf_username }}@{{ inbox.ruf_account_domain.as_deref().unwrap_or("?") }}</strong>.
    </p>
    <form method="post" action="/domains/{{ domain_id }}/dmarc/ruf/delete" class="form-inline">
        <button type="submit" class="button-danger button-small">Remove ruf inbox</button>
    </form>
    {% else %}
    <p>No DMARC failure report (ruf) inbox configured. Defaults to <code>postmaster@{{ domain_name }}</code>.</p>
    {% endif %}
    {% if !domain_accounts.is_empty() %}
    <form method="post" action="/domains/{{ domain_id }}/dmarc/ruf">
        <label for="dmarc_ruf_account_id">Set DMARC ruf inbox account:</label>
        <select name="account_id" id="dmarc_ruf_account_id" required>
            <option value="">— Select account —</option>
            {% for a in domain_accounts %}
            <option value="{{ a.id }}">{{ a.username }}@{{ a.domain_name.as_deref().unwrap_or("?") }}</option>
            {% endfor %}
        </select>
        <button type="submit">Save</button>
    </form>
    {% endif %}
    {% else %}
    <p><small>Configure a DMARC rua inbox above before setting an ruf inbox.</small></p>
    {% endif %}
</section>
<aside>
    <h2>Reverse DNS</h2>
    <p>Ask your provider to point the PTR record for your public IP back to <code>{{ hostname }}</code>.</p>
    <p><a href="/domains">Back to Domains</a></p>
</aside>
{% endblock %}
