{% extends "layout.html" %}
{% block title %}MCP — Model Context Protocol{% endblock %}
{% block content %}
<section>
    <hgroup>
        <small>AI integration</small>
        <h1>MCP — Model Context Protocol</h1>
    </hgroup>
    <p>This server exposes a <strong>JSON-RPC 2.0</strong> endpoint at <code>{{ endpoint_url }}</code> that AI agents can use to manage email via the <a href="https://modelcontextprotocol.io" target="_blank">Model Context Protocol</a>.</p>
</section>

<section>
    <hgroup>
        <small>Connection details</small>
        <h2>Endpoint</h2>
    </hgroup>
    <dl>
        <dt>URL</dt><dd><code>{{ endpoint_url }}</code></dd>
        <dt>Method</dt><dd><code>POST</code></dd>
        <dt>Content-Type</dt><dd><code>application/json</code></dd>
        <dt>Authentication</dt><dd>HTTP Basic Auth — same admin username and password as the web UI</dd>
        <dt>Protocol</dt><dd>JSON-RPC 2.0 / MCP 2024-11-05</dd>
    </dl>
</section>

<section>
    <hgroup>
        <small>Available tools</small>
        <h2>Tools</h2>
    </hgroup>
    <table>
        <thead>
            <tr><th>Tool</th><th>Description</th><th>Required parameters</th></tr>
        </thead>
        <tbody>
            <tr>
                <td><code>list_accounts</code></td>
                <td>List all mail accounts on the server</td>
                <td>—</td>
            </tr>
            <tr>
                <td><code>list_emails</code></td>
                <td>List emails in a mail account's inbox or named folder (20 per page)</td>
                <td><code>account_id</code></td>
            </tr>
            <tr>
                <td><code>read_email</code></td>
                <td>Read the full content of a single email</td>
                <td><code>account_id</code>, <code>filename</code></td>
            </tr>
            <tr>
                <td><code>send_email</code></td>
                <td>Send an email from a mail account via the local SMTP server</td>
                <td><code>account_id</code>, <code>to</code>, <code>subject</code>, <code>body</code></td>
            </tr>
            <tr>
                <td><code>delete_email</code></td>
                <td>Permanently delete an email from a mail account</td>
                <td><code>account_id</code>, <code>filename</code></td>
            </tr>
        </tbody>
    </table>
</section>

<section>
    <hgroup>
        <small>AI guardrails</small>
        <h2>Harness</h2>
    </hgroup>
    <p>These rules are returned in the <code>instructions</code> field of every <code>initialize</code> response and govern how AI agents connected to this server must behave. They are designed to prevent unintended or destructive actions.</p>
    <ol>
        {% for rule in harness_rules %}
        <li>{{ rule }}</li>
        {% endfor %}
    </ol>
</section>

<section>
    <hgroup>
        <small>AI agent setup</small>
        <h2>Claude Project File</h2>
    </hgroup>
    <p>Save the following as <code>email-agent.claude-project</code> to connect Claude to this mail server. Replace <code>YOUR_PASSWORD</code> with your admin password.</p>
    <pre><code>{
  "name": "Email Automation Agent",
  "description": "An MCP-powered email assistant that manages inboxes, summarizes messages, drafts replies, and performs email operations safely.",
  "instructions": [
    "You are an email automation agent connected to an MCP server named 'mailserver'.",
    "Use ONLY the provided MCP tools: list_accounts, list_emails, read_email, send_email, delete_email.",
    "Never invent email content. Always call read_email before summarizing, replying, or deleting.",
    "When asked to check inboxes, list accounts then list emails for each account.",
    "When asked to reply, always read the email first, draft a reply, and ask for approval before sending.",
    "When asked to delete, confirm the message by reading it, then ask for approval before deletion.",
    "If instructions are ambiguous, ask for clarification.",
    "Match the sender's tone when drafting replies unless instructed otherwise.",
    "Keep summaries concise unless asked for detail.",
    "Start each session by asking: 'Which email account or task would you like me to handle today?'"
  ],
  "mcpServers": {
    "mailserver": {
      "url": "{{ endpoint_url }}",
      "auth": {
        "type": "basic",
        "username": "admin",
        "password": "YOUR_PASSWORD"
      }
    }
  }
}</code></pre>
</section>

<section>
    <hgroup>
        <small>Quick start</small>
        <h2>Usage example</h2>
    </hgroup>
    <details>
        <summary>Initialize connection</summary>
        <pre><code>curl -s -u admin:password -X POST {{ endpoint_url }} \
  -H 'Content-Type: application/json' \
  -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}'</code></pre>
    </details>
    <details>
        <summary>List available tools</summary>
        <pre><code>curl -s -u admin:password -X POST {{ endpoint_url }} \
  -H 'Content-Type: application/json' \
  -d '{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}'</code></pre>
    </details>
    <details>
        <summary>List accounts</summary>
        <pre><code>curl -s -u admin:password -X POST {{ endpoint_url }} \
  -H 'Content-Type: application/json' \
  -d '{"jsonrpc":"2.0","id":3,"method":"tools/call","params":{"name":"list_accounts","arguments":{}}}'</code></pre>
    </details>
    <details>
        <summary>List emails for account 1</summary>
        <pre><code>curl -s -u admin:password -X POST {{ endpoint_url }} \
  -H 'Content-Type: application/json' \
  -d '{"jsonrpc":"2.0","id":4,"method":"tools/call","params":{"name":"list_emails","arguments":{"account_id":1}}}'</code></pre>
    </details>
    <details>
        <summary>Send an email</summary>
        <pre><code>curl -s -u admin:password -X POST {{ endpoint_url }} \
  -H 'Content-Type: application/json' \
  -d '{
  "jsonrpc":"2.0","id":5,"method":"tools/call",
  "params":{
    "name":"send_email",
    "arguments":{
      "account_id":1,
      "to":"recipient@example.com",
      "subject":"Hello from MCP",
      "body":"This email was sent via the MCP API."
    }
  }
}'</code></pre>
    </details>
</section>

<section>
    <hgroup>
        <small>{{ total_calls }} total call(s)</small>
        <h2>Call Logs</h2>
    </hgroup>
    {% if logs.is_empty() %}
    <p>No MCP calls recorded yet.</p>
    {% else %}
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Date</th>
                <th>Method</th>
                <th>Tool</th>
                <th>Status</th>
                <th>Duration</th>
                <th>Error</th>
            </tr>
        </thead>
        <tbody>
        {% for l in logs %}
        <tr style="cursor:pointer" title="Click to view full request" onclick="showMcpLog(this)" data-body="{% if let Some(b) = l.request_body.as_ref() %}{{ b }}{% endif %}">
            <td>{{ l.id }}</td>
            <td>{{ l.created_at }}</td>
            <td><code>{{ l.method }}</code></td>
            <td>{% if !l.tool.is_empty() %}<code>{{ l.tool }}</code>{% else %}—{% endif %}</td>
            <td>{% if l.success %}<mark data-variant="success">ok</mark>{% else %}<mark data-variant="danger">error</mark>{% endif %}</td>
            <td>{% if let Some(ms) = l.duration_ms %}{{ ms }} ms{% else %}—{% endif %}</td>
            <td>{% if !l.error.is_empty() %}<small>{{ l.error }}</small>{% endif %}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% if total_pages > 1 %}
    <nav>
        {% if page > 1 %}<a href="/mcp?page={{ page - 1 }}">&laquo; Prev</a>{% endif %}
        <span>Page {{ page }} / {{ total_pages }}</span>
        {% if page < total_pages %}<a href="/mcp?page={{ page + 1 }}">Next &raquo;</a>{% endif %}
    </nav>
    {% endif %}
    {% endif %}
</section>

<dialog id="mcp-log-dialog" style="max-width:780px;width:95%;padding:1.5rem;border:1px solid var(--color-border);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
        <strong>Full Request Dump</strong>
        <button type="button" onclick="document.getElementById('mcp-log-dialog').close()" style="background:none;border:none;font-size:1.25rem;cursor:pointer;line-height:1" aria-label="Close">&times;</button>
    </div>
    <pre id="mcp-log-body" style="overflow:auto;max-height:60vh;background:var(--color-bg-subtle);padding:1rem;border-radius:var(--radius-md);font-size:var(--font-size-sm);white-space:pre-wrap;word-break:break-all"></pre>
</dialog>
<script>
function showMcpLog(row) {
    var raw = row.dataset.body || '';
    var display = raw;
    if (raw) {
        try { display = JSON.stringify(JSON.parse(raw), null, 2); } catch(e) {}
    } else {
        display = '(no request body recorded)';
    }
    document.getElementById('mcp-log-body').textContent = display;
    document.getElementById('mcp-log-dialog').showModal();
}
</script>
{% endblock %}
