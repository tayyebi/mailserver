{% extends "layout.html" %}
{% block title %}Webmail{% endblock %}
{% block content %}
<h1>Webmail</h1>
<form method="get" action="/webmail">
  <label for="account_id">Account:</label>
  <select name="account_id" id="account_id">
    <option value="">— Select account —</option>
    {% for a in accounts %}
    <option value="{{ a.id }}"{% if let Some(sel) = selected_account %}{% if sel.id == a.id %} selected{% endif %}{% endif %}>{{ a.username }}@{{ a.domain_name.as_deref().unwrap_or("?") }}</option>
    {% endfor %}
  </select>
  <button type="submit">Select</button>
  <a href="/webmail/compose{% if let Some(sel) = selected_account %}?account_id={{ sel.id }}{% endif %}">Compose</a>
</form>

{% if let Some(sel) = selected_account %}
<div class="webmail-layout">

  <nav class="webmail-folders" aria-label="Folders">
    <strong>Folders</strong>
    <ul>
      {% for group in folder_groups %}
      {% if group.children.is_empty() %}
      <li>
        <a href="/webmail?account_id={{ sel.id }}&folder={{ group.folder.name }}"
           {% if group.folder.name == current_folder %}aria-current="page"{% endif %}>
          {{ group.folder.display_name }}
        </a>
      </li>
      {% else %}
      <li>
        <details {% if group.open %}open{% endif %}>
          <summary>
            <a href="/webmail?account_id={{ sel.id }}&folder={{ group.folder.name }}"
               {% if group.folder.name == current_folder %}aria-current="page"{% endif %}>
              {{ group.folder.display_name }}
            </a>
          </summary>
          <ul>
            {% for child in group.children %}
            <li>
              <a href="/webmail?account_id={{ sel.id }}&folder={{ child.name }}"
                 style="padding-inline-start: calc(var(--space-sm) + {{ child.depth }}rem);"
                 {% if child.name == current_folder %}aria-current="page"{% endif %}>
                {{ child.display_name }}
              </a>
            </li>
            {% endfor %}
          </ul>
        </details>
      </li>
      {% endif %}
      {% endfor %}
    </ul>
  </nav>

  <div class="webmail-list">
    <h2>{{ current_folder_name }} — {{ sel.username }}@{{ sel.domain_name.as_deref().unwrap_or("?") }}</h2>
    {% if emails.is_empty() %}
    <p>No emails found.</p>
    {% else %}
    <table>
      <thead>
        <tr><th>Date</th><th>From</th><th>Subject</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody>
        {% for email in emails %}
        <tr>
          <td>{{ email.date }}</td>
          <td>{{ email.from }}</td>
          <td><a href="/webmail/view/{{ email.filename }}?account_id={{ sel.id }}&folder={{ current_folder }}">{{ email.subject }}</a></td>
          <td>{% if email.is_new %}<strong>New</strong>{% else %}Read{% endif %}</td>
          <td>
            <form method="post" action="/webmail/delete/{{ email.filename }}" style="display:inline;">
              <input type="hidden" name="account_id" value="{{ sel.id }}">
              <input type="hidden" name="folder" value="{{ current_folder }}">
              <button type="submit" class="button-danger button-small">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if total_pages > 1 %}
    <nav class="pagination" aria-label="Pagination">
      {% if let Some(p) = prev_page %}
      <a href="/webmail?account_id={{ sel.id }}&folder={{ current_folder }}&page={{ p }}">← Previous</a>
      {% endif %}
      <span>Page {{ current_page }} of {{ total_pages }}</span>
      {% if let Some(n) = next_page %}
      <a href="/webmail?account_id={{ sel.id }}&folder={{ current_folder }}&page={{ n }}">Next →</a>
      {% endif %}
    </nav>
    {% endif %}

    {% endif %}
  </div>

</div>
{% endif %}

{% if !logs.is_empty() %}
<details>
  <summary>Verbose Log</summary>
  <pre>{% for line in logs %}{{ line }}
{% endfor %}</pre>
</details>
{% endif %}
{% endblock %}
