{% extends "layout.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<h1>Settings</h1>

<h2>Features</h2>
<dl>
<dt>Content Filter</dt>
<dd>
  {% if filter_enabled %}<mark style="color:var(--success)">Enabled</mark>{% else %}<mark style="color:var(--gray-400)">Disabled</mark>{% endif %}
  —
  {% if filter_healthy %}<mark style="color:var(--success)">● Healthy</mark>{% else %}<mark style="color:var(--danger)">● Unavailable</mark>{% endif %}
</dd>
<dt>Milter (OpenDKIM)</dt>
<dd>
  {% if milter_enabled %}<mark style="color:var(--success)">Enabled</mark>{% else %}<mark style="color:var(--gray-400)">Disabled</mark>{% endif %}
  —
  {% if milter_healthy %}<mark style="color:var(--success)">● Healthy</mark>{% else %}<mark style="color:var(--danger)">● Unavailable</mark>{% endif %}
</dd>
</dl>
<form method="post" action="/settings/features">
  <label><input type="checkbox" name="filter_enabled" value="on"{% if filter_enabled %} checked{% endif %}> Enable Content Filter (footer injection, tracking pixels)</label>
  <label><input type="checkbox" name="milter_enabled" value="on"{% if milter_enabled %} checked{% endif %}> Enable Milter / OpenDKIM (DKIM signing)</label>
  <button type="submit">Save Feature Settings</button>
</form>

<h2>Admin Account</h2>
<dl>
<dt>Username</dt><dd>{{ admin.username }}</dd>
<dt>2FA Status</dt><dd>{% if admin.totp_enabled %}Enabled{% else %}Disabled{% endif %}</dd>
</dl>

<h2>Change Password</h2>
<form method="post" action="/settings/password">
<label>Current Password<br><input type="password" name="current_password" required></label>
<label>New Password<br><input type="password" name="new_password" required></label>
<label>Confirm Password<br><input type="password" name="confirm_password" required></label>
<button type="submit">Change Password</button>
</form>

<h2>Two-Factor Authentication</h2>
{% if admin.totp_enabled %}
<form method="post" action="/settings/2fa/disable">
<button type="submit">Disable 2FA</button>
</form>
{% else %}
<p><a href="/settings/2fa">Enable 2FA</a></p>
{% endif %}

<h2>TLS Certificate</h2>
{% if cert_subject != "" %}
<dl>
<dt>Subject</dt><dd><code>{{ cert_subject }}</code></dd>
<dt>Issuer</dt><dd><code>{{ cert_issuer }}</code></dd>
<dt>Not Before</dt><dd>{{ cert_not_before }}</dd>
<dt>Not After</dt><dd>{{ cert_not_after }}</dd>
<dt>Serial</dt><dd><code>{{ cert_serial }}</code></dd>
</dl>
<p>
  <a href="/settings/tls/cert.pem">Download Certificate</a>
  <a href="/settings/tls/key.pem" onclick="return confirm('You are about to download the private key. This is a sensitive file. Continue?')">Download Private Key</a>
</p>
{% else %}
<p><em>No TLS certificate found at /data/ssl/cert.pem</em></p>
{% endif %}
<form method="post" action="/settings/tls/regenerate" onsubmit="return confirm('This will replace the current TLS certificate with a new self-signed certificate. All connected clients may need to re-trust the certificate. Continue?')">
<button type="submit">Regenerate Self-Signed Certificate</button>
</form>

<h2>Pixel Tracker</h2>
<form method="post" action="/settings/pixel">
  <label>Pixel Host<br>
    <input type="text" name="pixel_host" value="{{ pixel_host }}" required>
  </label>
  <label>Pixel Port (optional)<br>
    {% if pixel_port != "" %}
      <input type="number" name="pixel_port" value="{{ pixel_port }}">
    {% else %}
      <input type="number" name="pixel_port" value="">
    {% endif %}
  </label>
  <p>Computed pixel URL: <code>https://{{ pixel_host }}{% if pixel_port != "" %}:{{ pixel_port }}{% endif %}/pixel?id=</code></p>
  <button type="submit">Save Pixel Settings</button>
</form>

<h2>Service Management</h2>
<form method="post" action="/settings/restart-services" onsubmit="return confirm('This will restart Postfix, Dovecot, and OpenDKIM. Mail delivery will be briefly interrupted. Continue?')">
  <button type="submit">Restart Mail Services</button>
</form>
<form method="post" action="/settings/restart-container" onsubmit="return confirm('This will restart the entire Docker container. All services will be temporarily unavailable. Continue?')">
  <button type="submit">Restart Container</button>
</form>
<p><em>Note: Restarting the container requires the Docker socket to be mounted (<code>/var/run/docker.sock</code>).</em></p>

{% endblock %}
