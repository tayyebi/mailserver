{% extends "layout.html" %}
{% block title %}Webhooks{% endblock %}
{% block content %}
<h1>Webhooks</h1>

<h2>Webhook Settings</h2>
<p>When set, a POST request with JSON data will be sent to this URL each time an event occurs (email processed, domain/account/alias changes, fail2ban actions, etc.). Leave blank to disable.</p>
<form method="post" action="/webhooks/settings">
  <label>Webhook URL (optional)<br>
    <input type="url" name="webhook_url" value="{{ webhook_url }}" placeholder="https://example.com/webhook">
  </label>
  <button type="submit">Save Webhook URL</button>
</form>
<form method="post" action="/webhooks/test" class="form-compact">
  <button type="submit">Send Test Webhook</button>
  <small><em>ðŸ’¡ Save the URL above before testing.</em></small>
</form>

<h2>Webhook Logs</h2>
<p>{{ total_count }} total executions</p>
{% if logs.is_empty() %}
<p>No webhook executions recorded yet.</p>
{% else %}
<div class="table-wrap">
<table>
<thead>
<tr>
  <th>#</th>
  <th>Date</th>
  <th>Sender</th>
  <th>Subject</th>
  <th>URL</th>
  <th>Status</th>
  <th>Duration</th>
  <th>Error</th>
</tr>
</thead>
<tbody>
{% for l in logs %}
<tr>
  <td>{{ l.id }}</td>
  <td>{{ l.created_at }}</td>
  <td>{{ l.sender }}</td>
  <td>{{ l.subject }}</td>
  <td><code style="word-break:break-all;max-width:20ch;display:inline-block">{{ l.url }}</code></td>
  <td>{% if l.success %}<mark>{{ l.response_status }}</mark>{% else %}<strong>{{ l.response_status }}</strong>{% endif %}</td>
  <td>{{ l.duration_ms }}</td>
  <td>{% if !l.error.is_empty() %}<small>{{ l.error }}</small>{% endif %}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% if total_pages > 1 %}
<nav>
  {% if page > 1 %}<a href="/webhooks?page={{ page - 1 }}">&laquo; Prev</a>{% endif %}
  <span>Page {{ page }} / {{ total_pages }}</span>
  {% if page < total_pages %}<a href="/webhooks?page={{ page + 1 }}">Next &raquo;</a>{% endif %}
</nav>
{% endif %}
{% endif %}
{% endblock %}
